<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Roboto:100);
        html {
            padding: 0;
            margin: 0;
            height: 100vh;
        }
        body {
            background: #212121;
            color: #e0e0e0;
            position: absolute;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
<h1>Message Passing</h1>
<div id="status"></div>
<div id="root"></div>
<br/>
<div id="db"></div>
<script type="module">

  import {createConsecutiveObject, createConsecutiveArray} from './src/util.js'
  import {getDatabase} from './src/index.js'
  // import getDatabase from '@exports/db';
  console.log(createConsecutiveObject, getDatabase);
  const db = await getDatabase();
  db.info().then((info)=>{
    document.getElementById("db").innerHTML=`DOCS: ${info.doc_count} HOST: ${info.host}`;
  });

  db.changes({
    since: 'now',
    live: true,
  }).on('change', (changes)=>{
    db.info().then((info)=>{
      document.getElementById("db").innerHTML=`DOCS: ${info.doc_count} HOST: ${info.host}`;
    });
  })
  let retry = 0;

  // const log = console.log;
  // console.log = function(info) {
  //   const br = document.createElement("br");
  //   document.getElementById("root").innerHTML=info.msg || 'loading';
  //   document.getElementById("root").appendChild(br);
  //   log(...arguments);
  // };

  function update(id, str, inner=false, br=false){
    const el = document.createTextNode(str);
    if(br){
      const br = document.createElement("br");
      document.getElementById(id).appendChild(br);
    }

    if(inner){
      document.getElementById(id).innerHTML = '';
    }
    document.getElementById(id).appendChild(el);


  }

  function run() {
    console.log({
      msg: '🚀 Connecting to Service...',
      retry,
    });
    const ws = new WebSocket('ws://localhost:9090/');
    window.ws = ws;
    ws.onopen = function() {
      console.log({
        msg: '🎉 Connected to Service!',
        retry,
      });
      update("status", `🎉 Connected to Service! Retry ${retry}`, true);
      // socket.send(`asset/${15322902}`);
      ws.send(`blocks`);
      retry = 0;
    };
    // Listen for messages
    ws.addEventListener('message', function(event) {
      //console.log({msg: '📝 Message Received', event: event.data});
      const {type, data} = JSON.parse(event.data);
      update("root", `📝 Message Received ${type} ${data}`, false,true);
      // const el = document.createTextNode(`📝 Message Received ${type} ${data}`);
      // const br = document.createElement("br");
      // document.getElementById("root").appendChild(el);
      // document.getElementById("root").appendChild(br);
      if (type === 'SHUTDOWN') ws.close();
    });

    ws.onclose = function({reason}) {
      console.log({
        msg: '💥 Socket Closing',
        reason,
        retry,
      });
      update("status", `💥 Socket Closing! [Retry: ${retry} Reason: ${reason}]`, true, false);
      setTimeout(function() {
        retry++;
        run();
      }, 1000);
    };
  }
  run();
</script>
</body>
</html>
