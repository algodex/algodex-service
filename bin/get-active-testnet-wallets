#!/usr/bin/env node
/* eslint-disable require-jsdoc */
require('dotenv').config();

const getDatabases = require('../src/db/get-databases');
const map = require('../views/chart/map');
const databases = getDatabases();

const formattedEscrowDB = databases.formatted_escrow;
const formattedHistoryDB = databases.formatted_history;

const getWalletToDates = (rows, dateType) => {
  const walletToDates = rows.filter(row =>
    row.key !== undefined && row.value !== undefined)
      .filter(row => {
        const type = row.key.split(':')[1];
        return type === dateType;
      }).reduce((map, row) => {
        const wallet = row.key.split(':')[0];
        if (map[wallet] === undefined) {
          map[wallet] = new Set();
        }
        map[wallet].add(row.value);
        return map;
      }, {});
  return walletToDates;
};

async function run() {
  const accountData =
  await formattedEscrowDB.query('formatted_escrow/distinctDates',
      {reduce: false} );

  const tradeData =
    await formattedHistoryDB.query('formatted_history/activityView',
        {reduce: true, group: true} );

  const orderCountData =
    await formattedEscrowDB.query('formatted_escrow/openOrderCount',
        {reduce: true, group: true} );

  const walletToOrderCount = orderCountData.rows.reduce((map, row) => {
    const wallet = row.key;
    map[wallet] = row.value;
    return map;
  }, {});

  const walletToTradeData = tradeData.rows.reduce((map, row) => {
    const wallet = row.key;
    map[wallet] = row.value;
    return map;
  }, {});
  const walletToMonths = getWalletToDates(accountData.rows, 'month');
  const walletToDates = getWalletToDates(accountData.rows, 'date');
  const walletToInfo = {};
  
  // Object.keys(walletToDates).reduce( (map, wallet) => {
  //   const dateCount = walletToDates[wallet].size;
  //   const info = { dateCount };
  //   map[wallet] = info;
  //   return map;
  // }, {});

  const setData = (walletMap, walletToInfo, key) => {
    Object.keys(walletMap).forEach(wallet => {
      const val = walletMap[wallet].size || walletMap[wallet];
      if (walletToInfo[wallet] === undefined) {
        walletToInfo[wallet] = {};
      }
      walletToInfo[wallet][key] = val;
    });
  };
  setData(walletToMonths, walletToInfo, 'monthCount');
  setData(walletToDates, walletToInfo, 'dateCount');
  setData(walletToTradeData, walletToInfo, 'tradeCount');
  setData(walletToOrderCount, walletToInfo, 'orderCount');
  
  // Object.keys(walletToMonths).forEach(wallet => {
  //   const monthCount = walletToMonths[wallet].size;
  //   if (walletToInfo[wallet] === undefined) {
  //     walletToInfo[wallet] = {};
  //   }
  //   walletToInfo[wallet].monthCount = monthCount;
  // });
  // Object.keys(walletToTradeData).forEach(wallet => {
  //   const tradeCount = walletToTradeData[wallet];
  //   if (walletToInfo[wallet] === undefined) {
  //     walletToInfo[wallet] = {};
  //   }
  //   walletToInfo[wallet].tradeCount = tradeCount;
  // });
  // Object.keys(walletToOrderCount).forEach(wallet => {
  //   const orderCount = walletToOrderCount[wallet];
  //   if (walletToInfo[wallet] === undefined) {
  //     walletToInfo[wallet] = {};
  //   }
  //   walletToInfo[wallet].orderCount = orderCount;
  // });


  const wallets = Object.keys(walletToInfo).filter(wallet => {
    const entry = walletToInfo[wallet];
    const tradeCount = entry.tradeCount || 0;
    const orderCount = entry.orderCount || 0;
    const dateCount = entry.dateCount || 0;
    const monthCount = entry.monthCount || 0;
    return orderCount >= 5 && tradeCount >=10;
      /*monthCount >= 2 && dateCount >= 5*/;
  });
  console.log(wallets);
}

run();
