#!/usr/bin/env node

const getDatabase = require('../src/db');
const PouchDB = require('pouchdb');
PouchDB.plugin(require('pouchdb-erase'));

const couchBaseURL = process.env['COUCHDB_BASE_URL'] || 'http://admin:dex@localhost:5984';

const databases = {
  blocks: getDatabase(couchBaseURL + '/blocks'),
  escrow: getDatabase(couchBaseURL + '/escrow'),
  prices: getDatabase(couchBaseURL + '/prices'),
  assets: getDatabase(couchBaseURL + '/assets'),
  formattedEscrow: getDatabase(couchBaseURL + '/formatted_escrow'),
};

// .then(function() {
//   console.log('added asset: ' + assetId);
// }).catch(function(err) {
const deletePromises = [];
Object.values(databases).forEach( (db) => {
  deletePromises.push(
    db.destroy().then(function(res) {
      console.log('destroyed');
    }).catch(function(e) {
      console.log('could not delete');
    })
  );
});

Promise.all(deletePromises).then((res) => {
  console.log('starting creation');
  const databases2 = {
    blocks: getDatabase(couchBaseURL + '/blocks'),
    escrow: getDatabase(couchBaseURL + '/escrow'),
    prices: getDatabase(couchBaseURL + '/prices'),
    assets: getDatabase(couchBaseURL + '/assets'),
    formattedEscrow: getDatabase(couchBaseURL + '/formatted_escrow'),
  };
  //console.log({databases2});
});
