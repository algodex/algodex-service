#!/usr/bin/env node

const PouchDB = require('pouchdb');
PouchDB.plugin(require('pouchdb-erase'));

const databases = require('../src/db-config.js')();

const dbEndpoint = 'http://localhost:5984';
const dbUsername = 'admin';
const dbPassword = 'dex';

databases.forEach( (database) => {
  const initializedDB = new PouchDB(dbEndpoint + '/' + database.dbName, {
    auth: {
      username: dbUsername,
      password: dbPassword,
    },
  });

  initializedDB.get(database.design._id).then((res)=>{
    console.log('Index Found');
    initializedDB.put({...database.design, _rev: res._rev}).catch((e)=>{
      console.log('Update error', e);
      throw e;
    });
  }).catch((e)=>{
    console.log('Error Fetching Index', e.error);
    if (e.error === 'not_found') {
      console.log('Adding index');
      initializedDB.put({...database.design}).catch((e)=>{
        console.log('Create Error', e);
      });
    } else {
      throw e;
    }
  });
});


