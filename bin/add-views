#!/usr/bin/env node

const chartMap = require('../views/chart/map')
const chartReduce = require('../views/chart/reduce')
const orderMap = require('../views/orders/map')
const PouchDB = require('pouchdb')
PouchDB.plugin(require('pouchdb-erase'))

// create the remote database with authentication
const remote = new PouchDB('http://localhost:5984/dex', {
  auth: {
    username: 'admin',
    password: 'dex',
  },
})

const chartIndex = {
  _id: '_design/dex',
  views: {
    orders:{
      map: orderMap.toString()
    },
    ohlc: {
      map: chartMap.toString(),
      reduce: chartReduce.toString(),
    },
  },
}

remote.get('_design/dex').then((res)=>{
  console.log('Index Found')
  remote.put({...chartIndex, _rev: res._rev}).catch((e)=>{
    console.log('Update error', e)
    throw e;
  })
}).catch((e)=>{
  console.log('Error Fetching Index')
  if(e.error === 'not_found'){
    remote.put(chartIndex).catch((e)=>{
      console.log('Create Error', e)
    })
  } else {
    throw e;
  }
})
